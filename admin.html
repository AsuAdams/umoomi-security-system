<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Segoe UI;background:#f2f2f2;height:100vh;overflow:hidden}

/* HEADER */
header{
position:fixed;
top:0;left:0;right:0;
height:90px;
background:#ccdc;
display:flex;
align-items:center;
gap:15px;
padding:20px;
box-shadow:0 4px 6px rgba(0,0,0,.1);
z-index:1000;
}

/* LAYOUT */
.layout{
display:flex;
margin-top:110px;
height:calc(100vh - 110px);
padding:0 20px 20px 20px;
gap:20px;
}

/* SIDEBAR */
aside{
position:fixed;
top:110px;
left:20px;
width:240px;
bottom:20px;
background:white;
border-radius:10px;
padding:15px;
box-shadow:0 4px 6px rgba(0,0,0,.1);
overflow-y:auto;
}

aside button{
width:100%;
border:none;
background:none;
padding:10px 15px;
border-radius:6px;
text-align:left;
cursor:pointer;
margin-bottom:6px;
}

aside button:hover,
aside button.active{
background:#3498db;
color:white;
}

/* MAIN */
main{
margin-left:280px;
flex:1;
background:white;
border-radius:10px;
padding:20px;
box-shadow:0 4px 6px rgba(0,0,0,.1);
overflow-y:auto;
}

.section{display:none}
.section.active{display:block}

table{
width:100%;
border-collapse:collapse;
margin-top:15px;
}

th,td{
padding:8px;
border-bottom:1px solid #eee;
}

tr:hover{background:#f0f8ff}

button{
padding:5px 8px;
border:none;
border-radius:5px;
cursor:pointer;
}

.success{background:#2ecc71;color:white}
.warning{background:#f39c12;color:white}
.danger{background:#e74c3c;color:white}
.btn{background:#3498db;color:white}

input, select{
padding:6px;
width:100%;
margin-bottom:10px;
}

/* MODAL */
.modal{
position:fixed;
inset:0;
background:rgba(0,0,0,.7);
display:flex;
align-items:center;
justify-content:center;
z-index:2000;
}

.hidden{display:none}

.modal-box{
background:white;
padding:20px;
border-radius:8px;
width:450px;
}
</style>
</head>
<body>

<header>
<i class="fas fa-user-shield fa-2x"></i>
<div>
<h2>Admin Dashboard</h2>
<small>System Management Panel</small>
</div>
</header>

<div class="layout">

<aside>

<!-- 7 SIDEBAR BUTTONS -->
<button onclick="location.href='index.html'">
<i class="fas fa-home"></i> Dashboard
</button>

<button onclick="location.href='members.html'">
<i class="fas fa-users"></i> Members Page
</button>

<button onclick="location.href='scanner.html'">
<i class="fas fa-qrcode"></i> Scanner
</button>

<button onclick="location.href='scan-logs.html'">
<i class="fas fa-clipboard-list"></i> Logs
</button>

<button onclick="location.href='settings.html'">
<i class="fas fa-cog"></i> Settings
</button>

<hr style="margin:10px 0">

<button class="active" onclick="showSection('membersSection', this)">
<i class="fas fa-id-card"></i> Members Management
</button>

<button onclick="showSection('regionsSection', this)">
<i class="fas fa-map-marker-alt"></i> Regions Management
</button>

</aside>

<main>

<!-- MEMBERS -->
<div id="membersSection" class="section active">
<h3>Members Management</h3>
<button class="success" onclick="openMemberModal()">+ Add Member</button>

<table>
<thead>
<tr>
<th>Member ID</th>
<th>Name</th>
<th>Region</th>
<th>Expiry</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="membersTable"></tbody>
</table>
</div>

<!-- REGIONS -->
<div id="regionsSection" class="section">
<h3>Regions Management</h3>

<input id="regionInput" placeholder="New region name">
<button class="success" onclick="addRegion()">Add Region</button>

<table>
<thead>
<tr>
<th>Region Name</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="regionsTable"></tbody>
</table>

</div>

</main>
</div>

<!-- MEMBER MODAL -->
<div class="modal hidden" id="memberModal">
<div class="modal-box">
<h3>Add Member</h3>
<input id="m_member_id" placeholder="Member ID">
<input id="m_full_name" placeholder="Full Name">
<select id="m_region"></select>
<input type="date" id="m_expiry">
<button class="btn" onclick="saveMember()">Save</button>
<button onclick="closeMemberModal()">Cancel</button>
</div>
</div>

<script>

const SUPABASE_URL="https://pqrsljahrnjgkadflbmr.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcnNsamFocm5qZ2thZGZsYm1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTg0NTYsImV4cCI6MjA4NjEzNDQ1Nn0.egED0C2iRp6j3Xp4ldgrdI0GBep2J7VUR52rBbzsVdo";
const db=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

let regionsMap = {};

/* SECTION SWITCH */
function showSection(id, btn){
document.querySelectorAll(".section")
.forEach(s=>s.classList.remove("active"));

document.getElementById(id).classList.add("active");

document.querySelectorAll("aside button")
.forEach(b=>b.classList.remove("active"));

btn.classList.add("active");
}

/* LOAD REGIONS */
async function loadRegions(){

const { data, error } = await db.from("regions").select("*");

if(error){
console.error("Region load error:", error);
alert("Regions failed to load. Check console.");
return;
}

regionsMap = {};
data.forEach(r => regionsMap[r.id] = r.name);

regionsTable.innerHTML = data.map(r => `
<tr>
<td>${r.name}</td>
<td>
<button class="danger" onclick="deleteRegion('${r.id}')">
Delete
</button>
</td>
</tr>
`).join("");

m_region.innerHTML = data.map(r =>
`<option value="${r.id}">${r.name}</option>`
).join("");

}

/* LOAD MEMBERS */
async function loadMembers(){

const { data, error } = await db.from("umoomi_members").select("*");

if(error){
console.error("Member load error:", error);
alert("Members failed to load. Check console.");
return;
}

membersTable.innerHTML = data.map(m => `
<tr>
<td>${m.member_id}</td>
<td>${m.full_name}</td>
<td>${regionsMap[m.region_id] || ""}</td>
<td>${m.expiry_date || ""}</td>
<td>
<button class="danger" onclick="deleteMember('${m.id}')">
Delete
</button>
</td>
</tr>
`).join("");

}

/* ADD REGION */
async function addRegion(){
if(!regionInput.value) return;

await db.from("regions").insert({name: regionInput.value});
regionInput.value="";
loadRegions();
}

/* DELETE REGION */
async function deleteRegion(id){
await db.from("regions").delete().eq("id", id);
loadRegions();
}

/* ADD MEMBER */
function openMemberModal(){
memberModal.classList.remove("hidden");
}

function closeMemberModal(){
memberModal.classList.add("hidden");
}

async function saveMember(){

const payload = {
member_id: m_member_id.value,
full_name: m_full_name.value,
region_id: m_region.value,
expiry_date: m_expiry.value
};

await db.from("umoomi_members").insert(payload);

closeMemberModal();
loadMembers();
}

/* DELETE MEMBER */
async function deleteMember(id){
await db.from("umoomi_members").delete().eq("id", id);
loadMembers();
}

/* INIT */
loadRegions().then(loadMembers);

</script>

</body>
</html>
