<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - Umoomi Security System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
<div class="container">

  <header class="header">
    <h1><i class="fas fa-user-cog"></i> Admin Panel</h1>
  </header>

  <div class="status-bar" id="statusBar">
    <i class="fas fa-check-circle"></i> Ready
  </div>

  <form id="addMemberForm">

    <input id="memberId" placeholder="UM-HO-001" required />
    <input id="fullName" placeholder="Full Name" required />

    <select id="position" required>
      <option value="">Select Position</option>
      <option>Sadr Mulk</option>
      <option>Secretary</option>
      <option>Lead</option>
      <option>Assistant</option>
      <option>Regional Qaid</option>
      <option>Super Admin</option>
    </select>

    <select id="department" required>
      <option value="">Select Department</option>
      <option value="HO">Head Office</option>
      <option value="GO">General Office</option>
      <option value="RQ">Regional</option>
    </select>

    <input id="region" placeholder="Region" />
    <input id="phone" placeholder="+256..." />
    <input id="email" type="email" placeholder="Email" />
    <textarea id="address" placeholder="Address"></textarea>

    <select id="status">
      <option value="Active">Active</option>
      <option value="Inactive">Inactive</option>
      <option value="Suspended">Suspended</option>
    </select>

    <button type="submit">Add Member</button>
  </form>

</div>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ===============================
   SUPABASE CONFIG (SAFE)
================================ */
const SUPABASE_URL = "https://pqrsljahrnjgkadflbmr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcnNsamFocm5qZ2thZGZsYm1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTg0NTYsImV4cCI6MjA4NjEzNDQ1Nn0.egED0C2iRp6j3Xp4ldgrdI0GBep2J7VUR52rBbzsVdo";

const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===============================
   AUTO MEMBER ID
================================ */
document.getElementById('department').addEventListener('change', e => {
  document.getElementById('memberId').value = `UM-${e.target.value}-001`;
});

/* ===============================
   ADD MEMBER
================================ */
document.getElementById('addMemberForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const statusBar = document.getElementById('statusBar');
  statusBar.innerHTML = 'Saving...';

  const memberData = {
    member_id: memberId.value.trim(),
    full_name: fullName.value.trim(),
    position: position.value,
    department: department.value,
    region: region.value || null,
    phone: phone.value || null,
    email: email.value || null,
    address: address.value || null,
    status: status.value,
    current_location: null,
    last_scan: null,
    qr_code_url: `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=UMOOMI:${memberId.value}`
  };

  try {
    // CHECK DUPLICATE
    const { data: existing, error: checkError } = await supabase
      .from('umoomi_members')
      .select('member_id')
      .eq('member_id', memberData.member_id)
      .maybeSingle();

    if (checkError) throw checkError;
    if (existing) throw new Error('Member ID already exists');

    // INSERT
    const { error } = await supabase
      .from('umoomi_members')
      .insert(memberData);

    if (error) throw error;

    statusBar.innerHTML = '✅ Member added successfully';
    e.target.reset();

  } catch (err) {
    console.error(err);
    statusBar.innerHTML = `❌ ${err.message}`;
  }
});
</script>
</body>
</html>
