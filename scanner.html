<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Umoomi ID Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #111;
  color: white;
  text-align: center;
  padding: 20px;
}

#scanner {
  max-width: 350px;
  margin: auto;
}

.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  align-items: center;
  justify-content: center;
}

.card {
  background: white;
  color: black;
  border-radius: 12px;
  width: 320px;
  padding: 20px;
  animation: pop .3s ease;
}

.valid { border-top: 8px solid #27ae60; }
.invalid { border-top: 8px solid #e74c3c; }

img {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  object-fit: cover;
}

.status {
  font-size: 1.2rem;
  font-weight: bold;
  margin-top: 10px;
}

button {
  margin-top: 15px;
  padding: 10px;
  width: 100%;
  border: none;
  border-radius: 6px;
  background: #333;
  color: white;
}
</style>
</head>

<body>

<h2>üõÇ Security Scanner</h2>
<p>Scan Member QR Card</p>

<div id="scanner"></div>

<audio id="okSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="badSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<div class="modal" id="modal">
  <div class="card" id="card"></div>
</div>

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://pqrsljahrnjgkadflbmr.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcnNsamFocm5qZ2thZGZsYm1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTg0NTYsImV4cCI6MjA4NjEzNDQ1Nn0.egED0C2iRp6j3Xp4ldgrdI0GBep2J7VUR52rBbzsVdo";

const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ================= SCANNER ================= */
const scanner = new Html5Qrcode("scanner");

scanner.start(
  { facingMode: "environment" },
  { fps: 10, qrbox: 250 },
  async (memberId) => {
    scanner.stop();
    await handleScan(memberId);
  }
);

async function handleScan(memberId) {
  const modal = document.getElementById("modal");
  const card = document.getElementById("card");

  try {
    const { data: member, error } = await supabase
      .from("umoomi_members")
      .select("*")
      .eq("member_id", memberId)
      .single();

    if (error || !member) throw "NOT_FOUND";

    // ‚ùå BLOCK INACTIVE
    if (member.status !== "Active") throw "INACTIVE";

    // ‚úÖ SAVE SCAN LOG
    await supabase.from("scan_logs").insert({
      member_id: member.member_id,
      full_name: member.full_name,
      status: "VALID"
    });

    // UPDATE LAST SCAN
    await supabase
      .from("umoomi_members")
      .update({ last_scan: new Date() })
      .eq("member_id", memberId);

    document.getElementById("okSound").play();

    card.className = "card valid";
    card.innerHTML = `
      <img src="${member.photo_url || 'https://via.placeholder.com/120'}">
      <h3>${member.full_name}</h3>
      <p>${member.position}</p>
      <p>${member.department}</p>
      <div class="status">‚úÖ ACCESS GRANTED</div>
      <button onclick="closeModal()">Close</button>
    `;

  } catch (err) {
    document.getElementById("badSound").play();

    await supabase.from("scan_logs").insert({
      member_id: memberId,
      full_name: "UNKNOWN",
      status: "DENIED"
    });

    card.className = "card invalid";
    card.innerHTML = `
      <h3>‚ùå ACCESS DENIED</h3>
      <p>Invalid or Inactive ID</p>
      <div class="status">SECURITY ALERT</div>
      <button onclick="closeModal()">Close</button>
    `;
  }

  modal.style.display = "flex";
}

function closeModal() {
  document.getElementById("modal").style.display = "none";
  location.reload();
}
</script>

</body>
</html>
