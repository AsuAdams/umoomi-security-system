<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Umoomi Security System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- FONT AWESOME -->
<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

<!-- QR SCANNER -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:"Segoe UI",sans-serif;background:#f2f2f2;padding:20px}
.container{max-width:1400px;margin:auto}

/* HEADER */
header{
  background:white;padding:20px;border-radius:10px;
  display:flex;align-items:center;gap:15px;
  box-shadow:0 4px 6px rgba(0,0,0,.1);
  margin-bottom:25px
}
.logo i{font-size:2.5rem;color:#2c3e50}

/* LAYOUT */
.layout{display:grid;grid-template-columns:240px 1fr;gap:25px}

/* SIDEBAR */
aside{
  background:white;border-radius:10px;padding:15px;
  box-shadow:0 4px 6px rgba(0,0,0,.1)
}
aside a{
  display:block;padding:12px 15px;border-radius:6px;
  color:#2c3e50;text-decoration:none;margin-bottom:5px;
  cursor:pointer
}
aside a i{width:20px;margin-right:10px}
aside a.active,aside a:hover{background:#3498db;color:white}

/* MAIN */
main{
  background:white;border-radius:10px;padding:25px;
  box-shadow:0 4px 6px rgba(0,0,0,.1);
  height:calc(100vh - 170px);
  overflow:hidden
}

/* STATS */
.stats{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;margin-bottom:15px
}
.stat{
  background:linear-gradient(135deg,#2c3e50,#3498db);
  color:white;padding:25px;border-radius:10px;text-align:center
}
.stat i{font-size:2.3rem;margin-bottom:10px}
.stat .number{font-size:2rem;font-weight:bold}

/* SEARCH */
#searchInput{
  width:100%;padding:12px 15px;font-size:1rem;
  border-radius:6px;border:2px solid #ddd;margin-bottom:10px
}

/* TABLE */
.table-scroll{
  max-height:calc(100vh - 430px);
  overflow-y:auto;border-radius:6px
}
table{width:100%;border-collapse:collapse}
th{
  background:#2c3e50;color:white;padding:14px;
  position:sticky;top:0
}
td{padding:12px;border-bottom:1px solid #eee}
tr:hover{background:#f8f9fa;cursor:pointer}

.badge{padding:5px 10px;border-radius:20px;font-size:.8rem}
.active{background:#d4edda;color:#155724}
.expired{background:#f8d7da;color:#721c24}

/* MODAL */
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.7);
  display:none;align-items:center;justify-content:center;
  z-index:10
}
.modal-content{
  background:#fff;border-radius:12px;padding:20px;
  width:700px;display:flex;gap:25px
}

/* ID CARD */
.card{
  width:320px;height:200px;border-radius:12px;
  box-shadow:0 6px 15px rgba(0,0,0,.25);
  background:white;overflow:hidden
}
.front{padding:15px}
.front header{display:flex;gap:10px;margin-bottom:8px}
.front img{
  width:90px;height:110px;border-radius:8px;
  object-fit:cover;border:2px solid #ccc
}
.back{
  padding:15px;display:flex;
  flex-direction:column;justify-content:space-between;
  text-align:center
}
.qr{align-self:center}
.small{font-size:.7rem;color:#555}

.close{
  position:absolute;top:15px;right:20px;
  color:white;font-size:1.5rem;cursor:pointer
}
</style>
</head>

<body>
<div class="container">

<header>
  <div class="logo">
    <i class="fas fa-shield-alt"></i>
    <div>
      <h2>Umoomi Security System</h2>
      <small>Ahmadiyya Muslim Community Uganda</small>
    </div>
  </div>
</header>

<div class="layout">

<aside>
  <a class="active"><i class="fas fa-home"></i> Dashboard</a>
  <a><i class="fas fa-qrcode"></i> Scanner</a>
  <a onclick="location.href='admin.html'">
    <i class="fas fa-user-cog"></i> Admin Panel
  </a>
</aside>

<main>

<div class="stats">
  <div class="stat"><i class="fas fa-users"></i><div>Total</div><div id="totalMembers" class="number">0</div></div>
  <div class="stat"><i class="fas fa-user-check"></i><div>Active</div><div id="activeMembers" class="number">0</div></div>
  <div class="stat"><i class="fas fa-map-marker-alt"></i><div>Regions</div><div id="regions" class="number">0</div></div>
  <div class="stat"><i class="fas fa-clock"></i><div>Last Scan</div><div id="lastScan" class="number">-</div></div>
</div>

<input id="searchInput" placeholder="Search members by name or ID">

<div class="table-scroll">
<table>
<thead>
<tr>
<th>ID</th><th>Name</th><th>Position</th>
<th>Department</th><th>Region</th><th>Status</th>
</tr>
</thead>
<tbody id="membersBody"></tbody>
</table>
</div>

</main>
</div>
</div>

<!-- ID POPUP -->
<div class="modal" id="idModal">
<div class="close" onclick="idModal.style.display='none'">&times;</div>
<div class="modal-content">

<div class="card front">
<header>
<i class="fas fa-id-card"></i>
<strong>Official ID</strong>
</header>
<div style="display:flex;gap:12px">
<img id="mPhoto">
<div class="small">
<strong id="mName"></strong><br>
ID: <span id="mId"></span><br>
<span id="mPos"></span><br>
<span id="mDept"></span><br><br>
<span id="mExpiry" class="badge"></span>
</div>
</div>
</div>

<div class="card back">
<div id="qr" class="qr"></div>
<div class="small">
Valid only with official scanner<br>
Community Property
</div>
</div>

</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const client = window.supabase.createClient(
  "https://pqrsljahrnjgkadflbmr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcnNsamFocm5qZ2thZGZsYm1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTg0NTYsImV4cCI6MjA4NjEzNDQ1Nn0.egED0C2iRp6j3Xp4ldgrdI0GBep2J7VUR52rBbzsVdo"
);

let all=[];

async function loadMembers(){
  const { data } = await client.from("umoomi_members").select("*");
  all=data||[];
  render(all);

  totalMembers.textContent=all.length;
  activeMembers.textContent=all.filter(m=>m.status==="Active").length;
  regions.textContent=[...new Set(all.map(m=>m.region).filter(Boolean))].length;
}

function render(list){
  membersBody.innerHTML=list.map(m=>{
    const expired = m.expiry_date && new Date(m.expiry_date) < new Date();
    return `
    <tr onclick='showID(${JSON.stringify(m)})'>
      <td>${m.member_id}</td>
      <td>${m.full_name}</td>
      <td>${m.position}</td>
      <td>${m.department}</td>
      <td>${m.region||"-"}</td>
      <td>
        <span class="badge ${expired?"expired":"active"}">
          ${expired?"Expired":"Active"}
        </span>
      </td>
    </tr>`;
  }).join("");
}

searchInput.oninput=e=>{
  const q=e.target.value.toLowerCase();
  render(all.filter(m=>
    m.full_name.toLowerCase().includes(q) ||
    m.member_id.toLowerCase().includes(q)
  ));
};

function showID(m){
  mPhoto.src=m.photo_url||"https://via.placeholder.com/90";
  mName.textContent=m.full_name;
  mId.textContent=m.member_id;
  mPos.textContent=m.position;
  mDept.textContent=m.department;

  const expired = m.expiry_date && new Date(m.expiry_date) < new Date();
  mExpiry.textContent = m.expiry_date
    ? (expired ? "EXPIRED" : "Valid until "+m.expiry_date)
    : "No expiry set";
  mExpiry.className="badge "+(expired?"expired":"active");

  qr.innerHTML="";
  new QRCode(qr,{text:m.member_id,width:90,height:90});

  idModal.style.display="flex";
}

loadMembers();
</script>
</body>
</html>
